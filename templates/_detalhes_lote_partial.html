{% if lotes %}
<table class="table table-striped table-bordered table-sm">
    <!-- First Group: Existência, Reservado, Disponível, Lote, PV, PV I, Custo -->
    <thead class="thead-dark">
        <tr>
            <th class="text-right">Existência</th>
            <th class="text-right">Reservado</th>
            <th class="text-right">Disponível</th>
            <th>Lote</th>
            <th class="text-right">PV</th>
            <th class="text-right">PV I</th>
            {% if nivel_acesso > 0 %}
                <th class="text-right">Custo</th>
            {% endif %}
        </tr>
    </thead>
    <tbody>
        {% for lote in lotes %}
            <tr>
                <td class="text-right">{{ '%.2f'|format(lote.REXIST|float|default(0)) }}</td>
                <td class="text-right">{{ '%.2f'|format(lote.RENCCLI|float|default(0)) }}</td>
                <td class="text-right">{{ '%.2f'|format(lote.RSTKDISP|float|default(0)) }}</td>
                <td>{{ lote.RLOTE }}</td>
                <td class="text-right">{{ '%.2f'|format(lote.RPVP1|float|default(0)) }}</td>
                <td class="text-right">{{ '%.2f'|format(lote.RPVP2|float|default(0)) }}</td>
                {% if nivel_acesso > 0 %}
                    <td class="text-right">
                        {% if lote.RFIXACAO == 'S' %}
                            {{ '%.2f'|format(lote.RPRECO_COMPRA|float|default(0)) }}
                        {% else %}
                            {{ '%.2f'|format(lote.RPRECO_COMPRA|float|default(0)) }}
                        {% endif %}
                    </td>
                {% endif %}
            </tr>
        {% endfor %}
    </tbody>
    <!-- Second Group: Resultados Lab., Situação, Fornecedor -->
    <thead class="thead-light">
        <tr>
            <th>Resultados Lab.</th>
            <th>Situação</th>
            {% if nivel_acesso > 0 %}
                <th>Fornecedor</th>
            {% endif %}
            <!-- Empty cells to align with first group -->
            <th colspan="{{ 4 if nivel_acesso > 0 else 3 }}"></th>
        </tr>
    </thead>
    <tbody>
        {% for lote in lotes %}
            <tr>
                <td>{{ lote.LAB_RESULTS|safe }}</td>
                <td>{{ lote.RTIPOSITU }}</td>
                {% if nivel_acesso > 0 %}
                    <td>{{ lote.RNOMEFOR[:20] if lote.RNOMEFOR else '' }}</td>
                {% endif %}
                <!-- Empty cells to align with first group -->
                <td colspan="{{ 4 if nivel_acesso > 0 else 3 }}"></td>
            </tr>
        {% endfor %}
    </tbody>
    {% if nivel_acesso > 0 %}
        <tfoot>
            {% set pmc_qt = lotes|selectattr('RSTKDISP', 'gt', 0)|map(attribute='RSTKDISP')|map('float')|sum %}
            {% set pmc_exist = 0.0 %}
            {% for lote in lotes %}
                {% if lote.RSTKDISP|float > 0 %}
                    {% set pmc_exist = pmc_exist + ((lote.RSTKDISP|float) * (lote.RPRECO_COMPRA|float)) %}
                {% endif %}
            {% endfor %}
            {% if pmc_qt > 0 %}
                {% set pmc = pmc_exist / pmc_qt %}
            {% else %}
                {% set pmc = 0 %}
            {% endif %}
            <tr>
                <td colspan="{{ 6 if nivel_acesso > 0 else 5 }}" class="text-right font-weight-bold">Preços Médios...</td>
                <td class="font-weight-bold text-right">{{ '%.2f'|format(pmc) }}</td>
            </tr>
        </tfoot>
    {% endif %}
</table>

{% if debug %}
    <div class="mt-3">
        <strong>Debug: {{ lotes|length }} lotes encontrados</strong>
        <ul>
            {% for lote in lotes %}
                <li>Lote: {{ lote.RLOTE }} - Exist: {{ lote.REXIST }} - Disp: {{ lote.RSTKDISP }}</li>
            {% endfor %}
        </ul>
    </div>
{% endif %}

{% else %}
    <div class="alert alert-warning mt-3">
        Não foram encontrados lotes com existência para este artigo.
    </div>
{% endif %}